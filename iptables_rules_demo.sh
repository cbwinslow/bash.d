#!/bin/bash
# Interactive iptables rules demonstration

echo "=== IPTABLES RULES PROCESSING DEMO ==="
echo ""

echo "ğŸ¯ RULE PROCESSING ORDER:"
echo ""
echo "Imagine this scenario: SSH connection from 192.168.1.100"
echo ""

echo "CHAIN: INPUT (incoming traffic)"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ 1. Rule: DROP all from 192.168.1.0/24                  â”‚"
echo "â”‚    â””â”€â”€ Packet from 192.168.1.100 matches this rule!    â”‚"
echo "â”‚    â””â”€â”€ ACTION: DROP (reject)                           â”‚"
echo "â”‚    â””â”€â”€ PROCESSING STOPS HERE!                          â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ 2. Rule: ACCEPT SSH from 192.168.1.100                 â”‚"
echo "â”‚    â””â”€â”€ NEVER REACHED (blocked by rule #1)              â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ Default Policy: ACCEPT                                  â”‚"
echo "â”‚    â””â”€â”€ Only used if no rules match                      â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "âŒ RESULT: SSH blocked (even though rule #2 would allow it)"
echo ""

echo "ğŸ”„ FIXED VERSION (rules in correct order):"
echo ""
echo "CHAIN: INPUT"
echo "â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”"
echo "â”‚ 1. Rule: ACCEPT SSH from 192.168.1.100                 â”‚"
echo "â”‚    â””â”€â”€ Packet from 192.168.1.100 matches this rule!    â”‚"
echo "â”‚    â””â”€â”€ ACTION: ACCEPT (allow)                           â”‚"
echo "â”‚    â””â”€â”€ PROCESSING STOPS HERE!                          â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ 2. Rule: DROP all from 192.168.1.0/24                  â”‚"
echo "â”‚    â””â”€â”€ Never reached (already accepted)                 â”‚"
echo "â”‚                                                         â”‚"
echo "â”‚ Default Policy: DROP                                    â”‚"
echo "â”‚    â””â”€â”€ Only used if no rules match                      â”‚"
echo "â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜"
echo ""

echo "âœ… RESULT: SSH allowed (correct rule order)"
echo ""

echo "=== KEY CONCEPTS ==="
echo ""

echo "ğŸ¯ FIRST MATCH WINS:"
echo "   Rules are checked in order (first to last)"
echo "   Once a rule matches, processing stops"
echo ""

echo "ğŸ“‹ CHAINS:"
echo "   INPUT: Traffic coming TO your machine"
echo "   OUTPUT: Traffic going FROM your machine" 
echo "   FORWARD: Traffic passing THROUGH your machine"
echo ""

echo "ğŸ”§ ACTIONS (-j):"
echo "   ACCEPT: Allow the packet"
echo "   DROP: Silently discard (no response)"
echo "   REJECT: Discard and send error response"
echo "   RETURN: Exit current chain, continue in parent"
echo ""

echo "ğŸ“Š TABLES:"
echo "   filter: Packet filtering (default)"
echo "   nat: Network Address Translation"
echo "   mangle: Packet modification"
echo ""

echo "=== PRACTICAL EXAMPLES ==="
echo ""

echo "1. BLOCK SPECIFIC IP:"
echo "   sudo iptables -A INPUT -s 1.2.3.4 -j DROP"
echo "   â””â”€â”€ Block all incoming traffic from 1.2.3.4"
echo ""

echo "2. ALLOW SSH ONLY FROM HOME:"
echo "   sudo iptables -A INPUT -p tcp --dport 22 -s 192.168.1.100 -j ACCEPT"
echo "   sudo iptables -A INPUT -p tcp --dport 22 -j DROP"
echo "   â””â”€â”€ Allow SSH from your home IP, block from everywhere else"
echo ""

echo "3. PORT FORWARDING:"
echo "   sudo iptables -t nat -A PREROUTING -p tcp --dport 80 -j REDIRECT --to-port 8080"
echo "   â””â”€â”€ Redirect incoming port 80 to port 8080"
echo ""

echo "4. LOGGING (for debugging):"
echo "   sudo iptables -A INPUT -j LOG --log-prefix 'iptables-dropped: '"
echo "   sudo iptables -A INPUT -j DROP"
echo "   â””â”€â”€ Log dropped packets before blocking them"
echo ""

echo "=== FOR ANONYMITY ==="
echo ""

echo "ğŸ”’ TOR FORCING LOGIC:"
echo "   1. Check if packet is from Tor user â†’ ALLOW"
echo "   2. Check if packet is local network â†’ BYPASS"
echo "   3. Everything else â†’ REDIRECT through Tor"
echo ""

echo "âš ï¸  WARNING: Wrong order can break your anonymity!"
echo "   Always test rules in a safe environment first"