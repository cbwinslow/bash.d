"""
Vulnerability Scanner Agent

Comprehensive vulnerability assessment and security scanning expert

Specialization: vulnerability_scanning
Type: security

OpenAI Compatible: Yes
MCP Compatible: Yes
A2A Protocol: Enabled
"""

from typing import Dict, Any, List
from ..base import BaseAgent, AgentType, AgentCapability, Task


class VulnerabilityScannerAgent(BaseAgent):
    """
    Vulnerability Scanner - Comprehensive vulnerability assessment and security scanning expert

    This specialized agent performs thorough vulnerability assessments across applications,
    infrastructure, and networks. It identifies security weaknesses, categorifies risks,
    and provides remediation guidance using industry-standard tools and frameworks.
    """

    def __init__(self, **data):
        """Initialize the Vulnerability Scanner agent"""

        # Set defaults
        if "name" not in data:
            data["name"] = "Vulnerability Scanner"
        if "type" not in data:
            data["type"] = AgentType.SECURITY
        if "description" not in data:
            data["description"] = (
                "Comprehensive vulnerability assessment and security scanning expert specializing in identifying, categorizing, and prioritizing security weaknesses across applications, infrastructure, and networks using industry-standard tools and frameworks"
            )
        if "tags" not in data:
            data["tags"] = [
                "security",
                "vulnerability_assessment",
                "security_scanning",
                "risk_analysis",
                "penetration_testing",
            ]

        # Set security-focused capabilities
        if "capabilities" not in data:
            data["capabilities"] = [
                "Application vulnerability scanning",
                "Network security assessment",
                "Infrastructure vulnerability analysis",
                "Dependency vulnerability detection",
                "Static Application Security Testing (SAST)",
                "Dynamic Application Security Testing (DAST)",
                "Container security scanning",
                "Cloud security assessment",
                "API security testing",
                "Zero-day vulnerability detection",
            ]

        # Set security-focused tools
        if "config" not in data:
            data["config"] = {}
        if "tools" not in data["config"]:
            data["config"]["tools"] = [
                "nessus_scanner",
                "owasp_zap",
                "burp_suite",
                "nmap",
                "nikto",
            ]

        # Set custom security settings
        data["config"]["custom_settings"] = {
            "scan_depth": "comprehensive",
            "severity_threshold": "medium",
            "cve_database_integration": True,
            "automated_remediation_suggestions": True,
            "compliance_frameworks": ["OWASP_TOP10", "CWE", "NIST"],
            "report_format": "detailed",
            "continuous_monitoring": True,
        }

        # Initialize parent
        super().__init__(**data)

        # Add detailed capabilities
        self.capabilities.extend(
            [
                AgentCapability(
                    name="application_vulnerability_scanning",
                    description="Comprehensive scanning of web and mobile applications for security vulnerabilities",
                    parameters={
                        "scan_type": "string",
                        "target": "string",
                        "depth": "string",
                    },
                    required=True,
                ),
                AgentCapability(
                    name="network_security_assessment",
                    description="Network infrastructure vulnerability assessment and port scanning",
                    parameters={"network_range": "string", "scan_intensity": "string"},
                    required=True,
                ),
                AgentCapability(
                    name="static_application_security_testing",
                    description="Source code analysis for security vulnerabilities without executing code",
                    parameters={
                        "language": "string",
                        "codebase_path": "string",
                        "ruleset": "string",
                    },
                    required=True,
                ),
                AgentCapability(
                    name="dynamic_application_security_testing",
                    description="Runtime application security testing by simulating attacks",
                    parameters={"target_url": "string", "attack_vectors": "list"},
                    required=True,
                ),
                AgentCapability(
                    name="dependency_vulnerability_analysis",
                    description="Analysis of third-party dependencies for known vulnerabilities",
                    parameters={
                        "package_manager": "string",
                        "dependency_file": "string",
                    },
                    required=True,
                ),
                AgentCapability(
                    name="container_security_scanning",
                    description="Docker container and Kubernetes security vulnerability assessment",
                    parameters={"container_image": "string", "scan_type": "string"},
                    required=True,
                ),
                AgentCapability(
                    name="api_security_testing",
                    description="REST/GraphQL API security vulnerability assessment",
                    parameters={"api_endpoint": "string", "authentication": "object"},
                    required=True,
                ),
                AgentCapability(
                    name="cloud_security_assessment",
                    description="Cloud infrastructure security posture assessment",
                    parameters={"cloud_provider": "string", "services": "list"},
                    required=True,
                ),
                AgentCapability(
                    name="zero_day_vulnerability_detection",
                    description="Advanced analysis for unknown vulnerabilities using machine learning",
                    parameters={"target": "string", "analysis_depth": "string"},
                    required=True,
                ),
                AgentCapability(
                    name="vulnerability_prioritization",
                    description="Risk-based vulnerability prioritization using CVSS scoring",
                    parameters={
                        "vulnerabilities": "list",
                        "business_context": "object",
                    },
                    required=True,
                ),
            ]
        )

        # Add metadata
        self.metadata.update(
            {
                "specialization": "vulnerability_scanning",
                "category": "security",
                "index": 1,
                "scan_types": ["SAST", "DAST", "IAST", "SCA"],
                "supported_frameworks": ["OWASP", "NIST", "ISO27001", "SOC2"],
                "tools_integration": [
                    "Nessus",
                    "OWASP ZAP",
                    "Burp Suite",
                    "Nmap",
                    "Nikito",
                ],
                "compliance_standards": ["PCI-DSS", "HIPAA", "GDPR", "SOX"],
            }
        )

    async def execute_task(self, task: Task) -> Dict[str, Any]:
        """Execute a vulnerability scanning task"""
        input_data = task.input_data
        scan_type = input_data.get("scan_type", "comprehensive")
        target = input_data.get("target")

        # Simulate vulnerability scanning process
        vulnerabilities_found = [
            {
                "id": "CVE-2024-001",
                "severity": "high",
                "title": "SQL Injection in login form",
                "description": "SQL injection vulnerability found in authentication endpoint",
                "remediation": "Use parameterized queries and input validation",
                "cvss_score": 8.1,
            },
            {
                "id": "CVE-2024-002",
                "severity": "medium",
                "title": "Cross-Site Scripting (XSS)",
                "description": "Reflected XSS in search functionality",
                "remediation": "Implement output encoding and CSP headers",
                "cvss_score": 6.1,
            },
        ]

        return {
            "status": "completed",
            "agent": self.name,
            "specialization": "vulnerability_scanning",
            "scan_results": {
                "target": target,
                "scan_type": scan_type,
                "vulnerabilities_found": len(vulnerabilities_found),
                "vulnerabilities": vulnerabilities_found,
                "risk_score": "HIGH",
                "recommendations": "Immediate patching required for high-severity issues",
            },
            "execution_time_ms": 2500,
        }

    def get_openai_function_schema(self) -> Dict[str, Any]:
        """Get OpenAI function schema"""
        return {
            "name": "vulnerability_scanner",
            "description": "Comprehensive vulnerability assessment and security scanning",
            "parameters": {
                "type": "object",
                "properties": {
                    "scan_type": {
                        "type": "string",
                        "enum": [
                            "application",
                            "network",
                            "infrastructure",
                            "api",
                            "container",
                            "comprehensive",
                        ],
                        "description": "Type of vulnerability scan to perform",
                    },
                    "target": {
                        "type": "string",
                        "description": "Target to scan (URL, IP range, codebase path, etc.)",
                    },
                    "severity_threshold": {
                        "type": "string",
                        "enum": ["low", "medium", "high", "critical"],
                        "description": "Minimum severity level to report",
                    },
                    "scan_depth": {
                        "type": "string",
                        "enum": ["quick", "standard", "comprehensive"],
                        "description": "Depth of vulnerability scan",
                    },
                },
                "required": ["target"],
            },
        }

    def get_scan_types(self) -> List[str]:
        """Get available vulnerability scan types"""
        return ["SAST", "DAST", "IAST", "SCA", "Network", "Container", "Cloud", "API"]

    def get_supported_tools(self) -> List[str]:
        """Get list of supported vulnerability scanning tools"""
        return [
            "nessus",
            "owasp_zap",
            "burp_suite",
            "nmap",
            "nikito",
            "snyk",
            "trivy",
            "checkmarx",
        ]

    def get_compliance_frameworks(self) -> List[str]:
        """Get supported compliance frameworks"""
        return ["OWASP_TOP10", "NIST", "ISO27001", "PCI-DSS", "SOC2", "HIPAA", "GDPR"]
